# 🔧 修复 503 错误 - 配置阿里云安全组

## 问题诊断

应用已成功部署并运行，但外部访问返回 **HTTP 503** 错误。

**原因**: 阿里云安全组未开放 3000 端口，导致外部无法访问。

---

## ✅ 解决方案：配置安全组规则

### 步骤 1: 登录阿里云控制台

1. 访问 [阿里云控制台](https://ecs.console.aliyun.com)
2. 进入 **云服务器 ECS** > **实例**

### 步骤 2: 找到您的服务器

找到 IP 为 `123.56.75.68` 的服务器实例

### 步骤 3: 配置安全组

1. 点击服务器实例，进入详情页
2. 点击 **安全组** 标签
3. 点击安全组 ID 进入安全组规则配置

### 步骤 4: 添加入站规则

点击 **添加安全组规则**，配置如下：

**规则 1: HTTP (端口 80)**
- **规则方向**: 入方向
- **授权策略**: 允许
- **优先级**: 1
- **协议类型**: 自定义 TCP
- **端口范围**: 80/80
- **授权对象**: 0.0.0.0/0
- **描述**: HTTP 访问

**规则 2: HTTPS (端口 443)**
- **规则方向**: 入方向
- **授权策略**: 允许
- **优先级**: 1
- **协议类型**: 自定义 TCP
- **端口范围**: 443/443
- **授权对象**: 0.0.0.0/0
- **描述**: HTTPS 访问

**规则 3: 应用端口 (端口 3000) ⚠️ 重要**
- **规则方向**: 入方向
- **授权策略**: 允许
- **优先级**: 1
- **协议类型**: 自定义 TCP
- **端口范围**: 3000/3000
- **授权对象**: 0.0.0.0/0
- **描述**: Next.js 应用端口

**规则 4: SSH (端口 22)**
- **规则方向**: 入方向
- **授权策略**: 允许
- **优先级**: 1
- **协议类型**: 自定义 TCP
- **端口范围**: 22/22
- **授权对象**: 0.0.0.0/0 (或限制为您的 IP)
- **描述**: SSH 访问

### 步骤 5: 保存并测试

1. 点击 **保存**
2. 等待 1-2 分钟让规则生效
3. 在浏览器访问: http://123.56.75.68:3000

---

## 📸 配置截图参考

### 安全组规则配置示例

```
入方向规则:
┌──────────┬────────┬──────┬──────────┬──────────────┬────────┐
│ 协议类型 │ 端口   │ 策略 │ 优先级   │ 授权对象     │ 描述   │
├──────────┼────────┼──────┼──────────┼──────────────┼────────┤
│ TCP      │ 22     │ 允许 │ 1        │ 0.0.0.0/0    │ SSH    │
│ TCP      │ 80     │ 允许 │ 1        │ 0.0.0.0/0    │ HTTP   │
│ TCP      │ 443    │ 允许 │ 1        │ 0.0.0.0/0    │ HTTPS  │
│ TCP      │ 3000   │ 允许 │ 1        │ 0.0.0.0/0    │ 应用   │
└──────────┴────────┴──────┴──────────┴──────────────┴────────┘
```

---

## 🔍 验证步骤

配置完成后，验证应用是否可访问：

### 方法 1: 浏览器访问
```
http://123.56.75.68:3000
```

### 方法 2: 命令行测试
```bash
curl -I http://123.56.75.68:3000
```

应该返回：
```
HTTP/1.1 307 Temporary Redirect
或
HTTP/1.1 200 OK
```

---

## ⚠️ 安全建议

### 生产环境建议

1. **限制 SSH 端口访问**
   - 将 SSH (22) 端口的授权对象改为您的固定 IP
   - 例如: `123.45.67.89/32`

2. **使用 Nginx 反向代理**
   - 配置 Nginx 监听 80/443 端口
   - 将 3000 端口仅对 localhost 开放
   - 参考: `deploy/nginx.conf.template`

3. **配置 SSL 证书**
   - 使用 Let's Encrypt 免费证书
   - 启用 HTTPS 访问

---

## 📝 当前应用状态

✅ **应用已正常运行**
- PM2 状态: online
- 监听地址: 0.0.0.0:3000
- 内存使用: ~57 MB

❌ **外部访问被阻止**
- 原因: 安全组未开放 3000 端口
- 解决: 按照上述步骤配置安全组规则

---

## 🆘 如果仍然无法访问

1. **检查服务器防火墙**
   ```bash
   ssh root@123.56.75.68
   sudo ufw status
   # 如果防火墙开启，需要允许 3000 端口
   sudo ufw allow 3000/tcp
   ```

2. **检查应用日志**
   ```bash
   pm2 logs tiktok-ai-mcn --lines 50
   ```

3. **检查端口监听**
   ```bash
   netstat -tlnp | grep 3000
   # 应该显示: 0.0.0.0:3000
   ```

---

配置完成后，应用应该可以正常访问了！🎉




